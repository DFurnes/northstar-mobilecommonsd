box: blisteringherb/scholarship@0.0.6

build:
  # The steps that will be executed on build
  steps:
    - script:
        name: update apt
        code: |-
          sudo apt-get update
          sudo apt-get -y install software-properties-common
          sudo LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
    - script:
        name: update composer
        code: sudo composer self-update
    - script:
        name: install mysql
        code: |-
          export DEBIAN_FRONTEND=noninteractive
          sudo -E apt-get -q -y install mysql-server
          mysqladmin -u root password root
          mysql -u root -proot -e "CREATE USER 'homestead'@'localhost' IDENTIFIED BY 'secret';"
          mysql -u root -proot -e "GRANT ALL PRIVILEGES ON *.* TO 'homestead'@'localhost' WITH GRANT OPTION;"
    - script:
          name: update php & install extensions
          code: |-
            sudo apt-get install php5.6 -y
            sudo apt-get install php5.6-curl php5.6-mbstring php5.6-mcrypt php5.6-mysql php5.6-xml php5.6-zip
    - leipert/composer-install@0.0.1
    - script:
        name: run phpunit tests
        code: |-
            cp .env.example .env
            mysql -u homestead -psecret -e "CREATE DATABASE mobilecommonsd_testing;"
            vendor/bin/phpunit

deploy:
  steps:
    - bundle-install
    - script:
        name: write private key env var
        code: |-
          export CAP_PRIVATE_KEY=`mktemp`
          echo -e $WERCKER_APP_KEY_PRIVATE > $CAP_PRIVATE_KEY
    - cap
  after-steps:
      - sherzberg/slack-notify:
          subdomain: dosomething
          token: $SLACK_TOKEN
          channel: $SLACK_ROOM
